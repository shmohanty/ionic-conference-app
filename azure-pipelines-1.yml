
trigger:
- main

variables:
- group: ionic-conference-app
- name: Alias
  value: $[variables.keystoreFileName]
- name: Password
  value: $[variables.keystorePassword]
- name: FileName
  value: $[variables.keystoreFileName]


steps:    
  - script: npm install -g @ionic/cli
    displayName: 'Install Ionic CLI'

  - task: Npm@1
    inputs:
      workingDir: '$(Build.SourcesDirectory)'
      command: install
    displayName: 'NPM Install'

  - powershell: |
      ionic cap build android --prod --no-open
      npx cap sync
      cd android
      ./gradlew assembleRelease
    workingDirectory: $(Build.SourcesDirectory)
    displayName: 'Build Android Project'
  

  - task: AndroidSigning@3
    inputs:
      apkFiles: '$(Build.SourcesDirectory)/android/app/build/outputs/apk/release/release-1.0.apk'
      apksign: true
      apksignerKeystoreFile: $(FileName)
      apksignerKeystorePassword: $(Password)
      apksignerKeystoreAlias: $(Alias)
      apksignerKeyPassword: $(Password)
      apksignerArguments: --out $(Build.SourcesDirectory)/android/app/build/outputs/apk/release/release-1.0.apk --verbose
      zipalign: false
    displayName: 'Sign the APK'

  - task: CopyFiles@2
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)'
      contents: "**/*.apk"
      targetFolder: "$(Build.ArtifactStagingDirectory)"
    displayName: "Copy unsigned APK to staging directory"

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)"
      ArtifactName: "new"
      publishLocation: "Container"
    displayName: "Publish artifacts"

  